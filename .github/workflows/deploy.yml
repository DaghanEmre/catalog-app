name: Deploy to Server

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    # ✅ Secrets -> Job-level env (Centralized)
    # NOTE: "Context access might be invalid" warnings in VS Code are false positives.
    # The editor's static analysis cannot verify your live GitHub secrets.
    env:
      SERVER_HOST: ${{ secrets['SERVER_HOST'] }}
      SERVER_USER: ${{ secrets['SERVER_USER'] }}
      SSH_PRIVATE_KEY: ${{ secrets['SSH_PRIVATE_KEY'] }}
      SERVER_PORT: ${{ secrets['SERVER_PORT'] }}

      # Server paths
      DEPLOY_DIR: /home/${{ secrets['SERVER_USER'] }}/app/deploy
      APP_DIR: /home/${{ secrets['SERVER_USER'] }}/app

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ✅ Robust secret check (set -euo pipefail + loop)
      - name: Check Required Secrets
        shell: bash
        run: |
          set -euo pipefail
          missing=()
          
          for k in SERVER_HOST SERVER_USER SSH_PRIVATE_KEY SERVER_PORT; do
            if [[ -z "${!k:-}" ]]; then
              missing+=("$k")
            fi
          done

          if (( ${#missing[@]} > 0 )); then
            echo "::error::Missing required secrets: ${missing[*]}"
            exit 1
          fi

          echo "✅ All required secrets are present."

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x backend/gradlew

      # ✅ Clean build (better for deployment)
      - name: Build with Gradle
        working-directory: backend
        run: ./gradlew --no-daemon clean build -x test

      # ✅ Auto-detect JAR (handles name changes, excludes -plain.jar)
      - name: Resolve JAR artifact
        id: jar
        shell: bash
        run: |
          set -euo pipefail
          
          # Find the most recent JAR, excluding -plain.jar
          JAR_PATH="$(ls -1t backend/build/libs/*.jar | grep -v -- '-plain\.jar$' | head -n 1 || true)"

          if [[ -z "${JAR_PATH}" ]]; then
            echo "::error::No deployable JAR found in backend/build/libs"
            ls -la backend/build/libs || true
            exit 1
          fi

          echo "✅ Found JAR: ${JAR_PATH}"
          echo "jar_path=${JAR_PATH}" >> "$GITHUB_OUTPUT"

      # ✅ Upload JAR to server (pinned version, env.* usage)
      - name: Upload JAR to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.SERVER_HOST }}
          username: ${{ env.SERVER_USER }}
          key: ${{ env.SSH_PRIVATE_KEY }}
          port: ${{ env.SERVER_PORT }}
          source: ${{ steps.jar.outputs.jar_path }}
          target: ${{ env.DEPLOY_DIR }}
          strip_components: 3

      # ✅ Deploy & Restart (pinned version, atomic deployment)
      - name: Deploy and restart application
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SERVER_HOST }}
          username: ${{ env.SERVER_USER }}
          key: ${{ env.SSH_PRIVATE_KEY }}
          port: ${{ env.SERVER_PORT }}
          script: |
            set -euo pipefail

            DEPLOY_DIR="${DEPLOY_DIR}"
            APP_DIR="${APP_DIR}"

            echo "✅ Ensuring directories exist..."
            mkdir -p "$DEPLOY_DIR" "$APP_DIR"

            echo "✅ Locating uploaded JAR..."
            cd "$DEPLOY_DIR"
            JAR_FILE="$(ls -1t *.jar | head -n 1 || true)"
            
            if [[ -z "${JAR_FILE}" ]]; then
              echo "❌ No JAR found in $DEPLOY_DIR"
              ls -la
              exit 1
            fi

            echo "✅ Found JAR: ${JAR_FILE}"

            echo "✅ Atomically promoting JAR -> app.jar"
            cp -f "$JAR_FILE" "$APP_DIR/app.jar"

            echo "✅ Restarting application..."
            
            # Option 1: systemd service (recommended)
            if command -v systemctl >/dev/null 2>&1 && systemctl list-unit-files | grep -q '^catalog-app\.service'; then
              echo "   Using systemd service: catalog-app"
              sudo systemctl restart catalog-app
              sudo systemctl status catalog-app --no-pager -l || true
              
            # Option 2: restart.sh fallback
            elif [[ -x "$APP_DIR/restart.sh" ]]; then
              echo "   Using restart script: restart.sh"
              cd "$APP_DIR"
              ./restart.sh
              
            else
              echo "❌ No systemd service 'catalog-app' and no executable restart.sh found."
              echo "   Please create one of:"
              echo "   - systemd service: /etc/systemd/system/catalog-app.service"
              echo "   - restart script: $APP_DIR/restart.sh"
              exit 1
            fi

            echo "✅ Deployment completed successfully!"

      # ✅ Optional: Health check
      - name: Verify deployment (health check)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.SERVER_HOST }}
          username: ${{ env.SERVER_USER }}
          key: ${{ env.SSH_PRIVATE_KEY }}
          port: ${{ env.SERVER_PORT }}
          script: |
            echo "⏳ Waiting for application to start (10 seconds)..."
            sleep 10
            
            echo "✅ Checking health endpoint..."
            if command -v curl >/dev/null 2>&1; then
              curl -fsS http://localhost:8080/actuator/health || {
                echo "⚠️ Health check failed, but deployment completed (Check logs for DB connection or Port availability)."
              }
            else
              echo "⚠️ curl not available, skipping health check."
            fi
